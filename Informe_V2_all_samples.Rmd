---
title: "miRNAs CIBERESUCICOVID secuela"
author: "Iván Benítez "
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(width = 1000000,
                      echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      fig.align ='center',
                      fig.height = 10,
                      fig.width = 10,
                      cache = FALSE,
                      tidy = TRUE)
```

```{r, library}
library(compareGroups)
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggplot2)
library(scales)
library(FactoMineR)
library(factoextra)
library(poLCA)
library(survminer)
library(survival)
library(cmprsk)
library(tidyLPA)
library(limma)
#library(Glimma)
library(glmnet)
#source("miRNA/02_R/volcanoplot2.R")
library(data.table)
library(ggplot2)
library(pROC)
library(Hmisc)
#source("miRNA/02_R/Violin.R")
#library(Deducer)
library(mgcv)
library(visibly)
library(ltm)
library(mixOmics)
library(DT)
source("02_R/Funcion_PCA_QualityControl_v2.R")
```

```{r, read data}
load(file = "07_Data/BBDD_05_09_22.RData")

dat2 <- dat
```


```{r, merge BBDD}
# Filtrado 
#dat <- dat %>% filter(IH_PorcCMD>=80 & !is.na(IH_icu_hostdat_validated))
## read miRNAs
miR <- xlsx::read.xlsx("07_Data/Info para IB análisis MM1 DdGC 211201.xlsx",sheetIndex = 3)
miR <- miR  %>%  tidyr::spread(miRNA.ID, log2.ct) 
aux <-  xlsx::read.xlsx("07_Data/Info para IB análisis MM1 DdGC 211201.xlsx",sheetIndex = 2)
miR <- merge(miR,aux,by = "ID.TRRM")
dat <- merge(miR, dat,by.x="RedCap",by.y="IH_subjid",all.y = TRUE)
dat$IH_subjid <- dat$RedCap

check <- xlsx::read.xlsx("07_Data/ID_paper_validacion.xlsx",sheetIndex = 1)
check2 <- xlsx::read.xlsx("07_Data/Muestras_REDCAP_140322.xlsx",sheetIndex = 1)

dat <- dat %>% filter(IH_subjid %in% check2$RedCap)
```

```{r}
dat$IH_IMC_cat <- cut(dat$IH_IMC,c(min(dat$IH_IMC,na.rm = TRUE),30,35,max(dat$IH_IMC,na.rm = TRUE)),labels = c("Normal.Overweight","Obese.ClassI","Obese.ClassII.III")) 
dat$syn_IMV_time <-  as.numeric(dat$IV_mv_datestart_validated -dat$IH_cestdat )
dat$syn_IMV_time[dat$syn_HOSP_time<0] <- NA
dat$syn_IMV_time[dat$syn_HOSP_time<0] <- NA
dat$syn_IMV_time[dat$syn_HOSP_time>200] <- NA
```

```{r}
# dat <- dat %>% filter(IH_PorcCMD>=80)
# 
# dat <- dat %>% filter(!is.na(AH_outcomes) & AH_outcomes != "Se desconoce")
#dat <- dat %>% filter(dat$AH_outcomes !="Transferido a otro hospital") 
dat <- dat %>% filter(dat$AH_outcomes != "Exitus lethalis")

#dat <- dat %>% filter(is.na(dat$ID.TRRM))

dat$AH_vap_ceterm[dat$AH_bactpneu_ceterm == "Se desconoce"] <- "No" 
# estudiar que es mejor
#dat <- dat %>% filter(AH_outcomes %in%  c("Alta hospitalaria vivo","Transferido a centro sociosanitario"))
# ,"Transferido a otro hospital"
```




```{r}
ss <- xlsx::read.xlsx("07_Data/2022.01.31_BDD_UCICOVID_Fechas_REVISADAS.xlsx",sheetIndex = 2) 
ss$Fecha.ingreso.uci <- ss$IH_icu_hostdat_validated
ss$AH_f_datehosp.excel <- ss$AH_f_datehosp_rev
ss$IH_hostdat_validated_rev <- as.Date(ss$IH_hostdat_validated_rev)
ss$IH_icu_hostdat_validated_rev <- as.Date(ss$IH_icu_hostdat_validated_rev)
dat <- merge(dat,ss %>% dplyr::select(IH_subjid,IH_fecha_muestra_rev,AH_f_datehosp.excel,IH_icu_hostdat_validated_rev,IH_hostdat_validated_rev ),by.x = "RedCap",by.y = "IH_subjid",all.x = TRUE)
dat$IH_fecha_muestra_rev <- if_else(is.na(dat$IH_fecha_muestra_rev),dat$FECHA.EXTRACCIÓN.de.muestra,dat$IH_fecha_muestra_rev)
dat$IH_icu_hostdat_validated.y <- if_else(is.na(dat$IH_icu_hostdat_validated_rev),dat$IH_icu_hostdat_validated,dat$IH_icu_hostdat_validated_rev)
dat$IH_icu_hostdat_validated <- dat$IH_icu_hostdat_validated.y
dat$IH_hostdat_validated <- if_else(is.na(dat$IH_hostdat_validated_rev), dat$IH_hostdat_validated, dat$IH_hostdat_validated_rev)
dat$AH_f_datehosp.excel <- as.Date(dat$AH_f_datehosp.excel)
dat$AH_f_datehosp.excel <- if_else(is.na(dat$AH_f_datehosp.excel),dat$AH_f_datehosp,dat$AH_f_datehosp.excel)
dat$AH_f_datehosp <- dat$AH_f_datehosp.excel
dat$IU_tiempo_muestra <- as.numeric(dat$IH_fecha_muestra_rev - dat$IH_icu_hostdat_validated)
```

```{r, new variables}
dat[which(dat$IH_sex == "No especificado"),"IH_sex"] <- NA
dat$IH_liver_mhyn <- ifelse(dat$IH_modliver_mhyn == "Si" | dat$IH_mildliv_mhyn == "Si", "Si","No") 
dat$IH_age_cat <- as.character(sjmisc::dicho(dat$IH_age_estimateyears))
dat$IH_IMC_cat <- as.character(sjmisc::dicho(dat$IH_IMC))

# Follow-up and outcomes 
dat$follow <- as.numeric(dat$AH_f_datehosp -  dat$IH_fecha_muestra_rev)
dat$exitus <- ifelse(dat$AH_outcomes == "Exitus lethalis",1,0)
dat$IMV <- ifelse(dat$AH_invasive_proccur == "Si",1,0)
dat$fecha_seguimiento_IMV <- dat$AH_f_datehosp 
dat$fecha_seguimiento_IMV[which(dat$IMV == 1)] <-  dat$IV_mv_datestart_validated[which(dat$IMV == 1)]
dat$follow_IMV <- as.numeric(dat$fecha_seguimiento_IMV -  dat$IH_icu_hostdat_validated)
dat$IMV_basal <- ifelse(dat$IMV == 1 &  dat$follow_IMV == 0,"Si","No")
dat$syn_ICU_time <- as.numeric(dat$IH_icu_hostdat_validated -dat$IH_cestdat )
dat$syn_HOSP_time <- as.numeric(dat$IH_hostdat_validated -dat$IH_cestdat )
dat$Hosp_ICU_time <- as.numeric(dat$IH_icu_hostdat_validated -dat$IH_hostdat_validated)
dat$ICU_IMV_time <- as.numeric(dat$IV_mv_datestart_validated -  dat$IH_icu_hostdat_validated)
dat$estancia_IMV <- as.numeric(dat$FV_fin_vmi_validated - dat$IV_mv_datestart_validated)

dat$estacia_UCI <-  dat$AU_alta_uci_validated - dat$IH_icu_hostdat_validated
dat$estacia_Hospital <- dat$AH_f_datehosp -  dat$IH_hostdat_validated   
## transform analitics parameters 
dat$IU_ldh_log <- log(dat$IU_ldh)
dat$IU_procalcitonin[which(dat$IU_procalcitonin == 0)] <- 0.0001
dat$IU_procalcitonin_log <- log(dat$IU_procalcitonin)
dat$IU_creatinine_log <- log(dat$IU_creatinine)
dat$IU_lymphocyte[which(dat$IU_lymphocyte == 0)] <- 0.1
dat$IU_lymphocyte_log <- log(dat$IU_lymphocyte)
dat$Neutrophil_to_lymphocyte <- log(dat$IU_neutrophil2/dat$IU_lymphocyte)
dat$IU_AST_log <- log(dat$IU_AST) 
dat$IU_ALT_log <- log(dat$IU_ALT)
dat$IU_urea_log <- log(dat$IU_urea)
dat$IU_lactate_log <- log(dat$IU_lactate)
dat$IU_cardbnp_log <- log(dat$IU_cardbnp)

# new variables 
dat$IU_pafi <- (dat$IU_pao2_daily/dat$IU_ef_ifo2_daily)*100
dat$IU_pafi[which(dat$IU_pafi>700)] <- NA


dat$IH_filtrado <- ifelse(dat$IH_sex == "Mujer",
       142*((apply(dat %>% dplyr::select(IH_creatinine),1,function(x) min(x/0.7,1))^c(-0.241)))*
         ((apply(dat %>% dplyr::select(IH_creatinine),1,function(x) max(x/0.7,1))^c(-1.200)))*
         (0.9938^dat$IH_age_estimateyears)*1.012,
       142*((apply(dat %>% dplyr::select(IH_creatinine),1,function(x) min(x/0.9,1))^c(-0.302)))*
         ((apply(dat %>% dplyr::select(IH_creatinine),1,function(x) max(x/0.9,1))^c(-1.200)))*
         (0.9938^dat$IH_age_estimateyears))


dat$IU_filtrado <- ifelse(dat$IH_sex == "Mujer",
       142*((apply(dat %>% dplyr::select(IU_creatinine),1,function(x) min(x/0.7,1))^c(-0.241)))*
         ((apply(dat %>% dplyr::select(IU_creatinine),1,function(x) max(x/0.7,1))^c(-1.200)))*
         (0.9938^dat$IH_age_estimateyears)*1.012,
       142*((apply(dat %>% dplyr::select(IU_creatinine),1,function(x) min(x/0.9,1))^c(-0.302)))*
         ((apply(dat %>% dplyr::select(IU_creatinine),1,function(x) max(x/0.9,1))^c(-1.200)))*
         (0.9938^dat$IH_age_estimateyears))

dat$IV_filtrado <- ifelse(dat$IH_sex == "Mujer",
       142*((apply(dat %>% dplyr::select(IV_creatinine),1,function(x) min(x/0.7,1))^c(-0.241)))*
         ((apply(dat %>% dplyr::select(IV_creatinine),1,function(x) max(x/0.7,1))^c(-1.200)))*
         (0.9938^dat$IH_age_estimateyears)*1.012,
       142*((apply(dat %>% dplyr::select(IV_creatinine),1,function(x) min(x/0.9,1))^c(-0.302)))*
         ((apply(dat %>% dplyr::select(IV_creatinine),1,function(x) max(x/0.9,1))^c(-1.200)))*
         (0.9938^dat$IH_age_estimateyears))

dat$D3_filtrado <- ifelse(dat$IH_sex == "Mujer",
       142*((apply(dat %>% dplyr::select(D3_creatinine),1,function(x) min(x/0.7,1))^c(-0.241)))*
         ((apply(dat %>% dplyr::select(D3_creatinine),1,function(x) max(x/0.7,1))^c(-1.200)))*
         (0.9938^dat$IH_age_estimateyears)*1.012,
       142*((apply(dat %>% dplyr::select(D3_creatinine),1,function(x) min(x/0.9,1))^c(-0.302)))*
         ((apply(dat %>% dplyr::select(D3_creatinine),1,function(x) max(x/0.9,1))^c(-1.200)))*
         (0.9938^dat$IH_age_estimateyears))

dat$FV_filtrado <- ifelse(dat$IH_sex == "Mujer",
       142*((apply(dat %>% dplyr::select(FV_creatinine),1,function(x) min(x/0.7,1))^c(-0.241)))*
         ((apply(dat %>% dplyr::select(FV_creatinine),1,function(x) max(x/0.7,1))^c(-1.200)))*
         (0.9938^dat$IH_age_estimateyears)*1.012,
       142*((apply(dat %>% dplyr::select(FV_creatinine),1,function(x) min(x/0.9,1))^c(-0.302)))*
         ((apply(dat %>% dplyr::select(FV_creatinine),1,function(x) max(x/0.9,1))^c(-1.200)))*
         (0.9938^dat$IH_age_estimateyears))

dat <- dat %>% mutate_if(is.factor, ~replace(., . == "Se desconoce",NA)) %>% mutate_if(is.factor, factor)
# 
# dat <- dat %>% filter(IH_hostdat_validated >"2020-03-18" & IH_hostdat_validated< "2021-02-16")

```

```{r,eval=TRUE}
dat$M3_result_tac_followup___6 <- ifelse(dat$M3_result_tac_followup___6 == 1,"Si","No")
dat$M6_result_tac_followup___6 <- ifelse(dat$M6_result_tac_followup___6 == 1,"Si","No")
dat <- dat %>%  mutate(
  M3_Xray0 = M3_result_xray_followup___0,
  M3_Xray1 = M3_result_xray_followup___1,
  M3_Xray2 = M3_result_xray_followup___2,
  M3_Xray3 = M3_result_xray_followup___3,
  M3_Xray4 = M3_result_xray_followup___4,
  M3_Xray5 = M3_result_xray_followup___5)


dat <- dat %>%  mutate(
  M3_tac0 = M3_result_tac_followup___0,
  M3_tac1 = M3_result_tac_followup___1,
  M3_tac2 = M3_result_tac_followup___2,
  M3_tac3 = M3_result_tac_followup___3,
  M3_tac4 = M3_result_tac_followup___4,
  M3_tac5 = M3_result_tac_followup___5,
  M3_tac6 = M3_result_tac_followup___6)


dat <- dat %>%  mutate(
  M6_Xray0 = M6_result_xray_followup___0,
  M6_Xray1 = M6_result_xray_followup___1,
  M6_Xray2 = M6_result_xray_followup___2,
  M6_Xray3 = M6_result_xray_followup___3,
  M6_Xray4 = M6_result_xray_followup___4,
  M6_Xray5 = M6_result_xray_followup___5)


dat <- dat %>%  mutate(
  M6_tac0 = M6_result_tac_followup___0,
  M6_tac1 = M6_result_tac_followup___1,
  M6_tac2 = M6_result_tac_followup___2,
  M6_tac3 = M6_result_tac_followup___3,
  M6_tac4 = M6_result_tac_followup___4,
  M6_tac5 = M6_result_tac_followup___5,
  M6_tac6 = M6_result_tac_followup___6)


dat <- dat %>%  mutate(
  Ribavirin = AH_antiviral_cmtrt___0,
  Lopinavir_ritonavir = AH_antiviral_cmtrt___1,
  Remdesivir = AH_antiviral_cmtrt___2,
  Interferon_alfa = AH_antiviral_cmtrt___3,
  Interferon_beta = AH_antiviral_cmtrt___4,
  Cloroquina = AH_antiviral_cmtrt___5,
  Hidroxicloroquina = AH_antiviral_cmtrt___6,
  Tocilizumab = AH_antiviral_cmtrt___7,
  Darunavir_cobicistat = AH_antiviral_cmtrt___8,
  Otros_antiviral = AH_antiviral_cmtrt___9)

dat <- dat %>%  mutate(
  Ribavirin = ifelse(AH_antiviral_cmyn == "No","No",Ribavirin),
  Lopinavir_ritonavir = ifelse(AH_antiviral_cmyn == "No","No",Lopinavir_ritonavir),
  Remdesivir = ifelse(AH_antiviral_cmyn == "No","No",Remdesivir),
  Interferon_alfa = ifelse(AH_antiviral_cmyn == "No","No",Interferon_alfa),
  Interferon_beta = ifelse(AH_antiviral_cmyn == "No","No",Interferon_beta),
  Cloroquina = ifelse(AH_antiviral_cmyn == "No","No",Cloroquina),
  Hidroxicloroquina = ifelse(AH_antiviral_cmyn == "No","No",Hidroxicloroquina),
  Tocilizumab = ifelse(AH_antiviral_cmyn == "No","No",Tocilizumab),
  Darunavir_cobicistat =ifelse(AH_antiviral_cmyn == "No","No",Darunavir_cobicistat),
  Otros_antiviral = ifelse(AH_antiviral_cmyn == "No","No",Otros_antiviral)
  )

```




## Información disponible en visitas de seguimiento 

### Pacientes con información en variables de seguimiento

```{r}
vec_var <- dat %>% dplyr::select(M3_emergency_visits_followup,M6_emergency_visits_followup,A1_emergency_visits_followup_2,
                      M3_admission_followup,M6_admission_followup,A1_admission_followup_2,
                      M3_exitus_followup,M6_exitus_followup,A1_exitus_followup_2,
                      M3_date_tac_followup,M6_date_tac_followup,A1_date_tac_followup_2,
                      M3_date_xray_followup,M6_date_xray_followup,A1_date_xray_followup_2,
                      M3_followup_spirometry_date,M6_followup_spirometry_date,A1_followup_spirometry_date_3,
                      M3_followup_dlco,M6_followup_dlco,A1_followup_dlco_3,
                      M3_followup_kco,M6_followup_kco,A1_followup_kco_2) %>% names

res <- apply(!is.na(dat %>% dplyr::select(vec_var)),2,sum) %>% matrix(.,ncol = 3,byrow = TRUE) %>%  as.data.frame()

colnames(res) <- c("Three.months","Six.months","Twelve.year")
rownames(res) <- c("Emergency","Hospital admission","Exitus","TAC","XRAY","Spirometry","DLCO","KCO")
DT::datatable(res,
  extensions = 'Buttons', options = list(
  pageLength = 20,
  dom = 'Bftip',
  buttons = c('copy', 'csv', 'excel', 'pdf')
),caption = "Table 1. Number of patients with information") 
```

### Paciente con información en más de una visita de seguimiento

```{r}
vec_var <- dat %>% dplyr::select(M3_emergency_visits_followup,M6_emergency_visits_followup,
                      M3_admission_followup,M6_admission_followup,
                      M3_exitus_followup,M6_exitus_followup,
                      M3_date_tac_followup,M6_date_tac_followup,
                      M3_date_xray_followup,M6_date_xray_followup,
                      M3_followup_spirometry_date,M6_followup_spirometry_date,
                      M3_followup_dlco,M6_followup_dlco,
                      M3_followup_kco,M6_followup_kco) %>% names

res_3_6 <- c(sum(apply(!is.na(dat %>% dplyr::select(vec_var[1:2])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[3:4])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[5:6])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[7:8])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[9:10])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[11:12])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[13:14])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[15:16])),1,sum)== 2))


vec_var <- dat %>% dplyr::select(M6_emergency_visits_followup,A1_emergency_visits_followup_2,
                      M6_admission_followup,A1_admission_followup_2,
                      M6_exitus_followup,A1_exitus_followup_2,
                      M6_date_tac_followup,A1_date_tac_followup_2,
                      M6_date_xray_followup,A1_date_xray_followup_2,
                      M6_followup_spirometry_date,A1_followup_spirometry_date_3,
                      M6_followup_dlco,A1_followup_dlco_3,
                      M6_followup_kco,A1_followup_kco_2) %>% names

res_6_1 <- c(sum(apply(!is.na(dat %>% dplyr::select(vec_var[1:2])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[3:4])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[5:6])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[7:8])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[9:10])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[11:12])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[13:14])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[15:16])),1,sum)== 2))

vec_var <- dat %>% dplyr::select(M3_emergency_visits_followup,A1_emergency_visits_followup_2,
                      M3_admission_followup,A1_admission_followup_2,
                      M3_exitus_followup,A1_exitus_followup_2,
                      M3_date_tac_followup,A1_date_tac_followup_2,
                      M3_date_xray_followup,A1_date_xray_followup_2,
                      M3_followup_spirometry_date,A1_followup_spirometry_date_3,
                      M3_followup_dlco,A1_followup_dlco_3,
                      M3_followup_kco,A1_followup_kco_2) %>% names


res_3_1 <- c(sum(apply(!is.na(dat %>% dplyr::select(vec_var[1:2])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[3:4])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[5:6])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[7:8])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[9:10])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[11:12])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[13:14])),1,sum)== 2),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[15:16])),1,sum)== 2))



vec_var <- dat %>% dplyr::select(M3_emergency_visits_followup,M6_emergency_visits_followup,A1_emergency_visits_followup_2,
                      M3_admission_followup,M6_admission_followup,A1_admission_followup_2,
                      M3_exitus_followup,M6_exitus_followup,A1_exitus_followup_2,
                      M3_date_tac_followup,M6_date_tac_followup,A1_date_tac_followup_2,
                      M3_date_xray_followup,M6_date_xray_followup,A1_date_xray_followup_2,
                      M3_followup_spirometry_date,M6_followup_spirometry_date,A1_followup_spirometry_date_3,
                      M3_followup_dlco,M6_followup_dlco,A1_followup_dlco_3,
                      M3_followup_kco,M6_followup_kco,A1_followup_kco_2) %>% names

res_3_6_1 <- c(sum(apply(!is.na(dat %>% dplyr::select(vec_var[1:3])),1,sum)== 3),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[4:6])),1,sum)== 3),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[7:9])),1,sum)== 3),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[10:12])),1,sum)== 3),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[13:15])),1,sum)== 3),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[16:18])),1,sum)== 3),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[19:21])),1,sum)== 3),
sum(apply(!is.na(dat %>% dplyr::select(vec_var[22:24])),1,sum)== 3))

res <- data.frame(res_3_6,res_6_1,res_3_6_1,res_3_1)

colnames(res) <- c("Three_and_Six","Six_and_twelve","Three_and_Six_and_twelve","Three_and_twelve")
rownames(res) <- c("Emergency","Hospital admission","Exitus","TAC","XRAY","Spirometry","DLCO","KCO")
DT::datatable(res,
  extensions = 'Buttons', options = list(
  pageLength = 20,
  dom = 'Bftip',
  buttons = c('copy', 'csv', 'excel', 'pdf')
),caption = "Table 1. Number of patients with information") 
```

## Creacion de visita seguimiento 

Se seleccionó los pacientes con visita de seguimiento con tiempo transcurrido desde el alta hospitalaria superior a dos meses. 

```{r}

aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_followup_dlco,M3_followup_spirometry_date,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., dlco = M3_followup_dlco, date = M3_followup_spirometry_date),
             dat %>% dplyr::select(IH_subjid,M6_followup_dlco,M6_followup_spirometry_date,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., dlco = M6_followup_dlco, date = M6_followup_spirometry_date)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date - AH_f_datehosp)))




aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_followup_dlco,M3_followup_spirometry_date,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., dlco = M3_followup_dlco, date = M3_followup_spirometry_date),
             dat %>% dplyr::select(IH_subjid,M6_followup_dlco,M6_followup_spirometry_date,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., dlco = M6_followup_dlco, date = M6_followup_spirometry_date),
             dat %>% dplyr::select(IH_subjid,A1_followup_dlco_3,A1_followup_spirometry_date_3,AH_f_datehosp)
             %>% mutate(time = "A1") %>% 
               rename(., dlco = A1_followup_dlco_3, date = A1_followup_spirometry_date_3)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date - AH_f_datehosp)))




aux2 <- aux %>% 
  group_by(IH_subjid) %>% 
  mutate( dif = abs(median(aux$time) - time)) %>% 
  slice(which.min(dif)) %>% 
  dplyr::select(IH_subjid,dlco,date)

names(aux2) <- c("IH_subjid","M36_followup_dlco","M36_followup_spirometry_date")
dat <- merge(dat,aux2,by="IH_subjid",all.x = TRUE)
```

```{r}

aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_result_tac_followup___0,M3_date_tac_followup,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., normalizacion = M3_result_tac_followup___0, date.norm = M3_date_tac_followup),
             dat %>% dplyr::select(IH_subjid,M6_result_tac_followup___0,M6_date_tac_followup,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., normalizacion = M6_result_tac_followup___0, date.norm = M6_date_tac_followup)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date.norm - AH_f_datehosp)))

aux2 <- aux %>% 
  group_by(IH_subjid) %>% 
  mutate( dif = abs(median(aux$time) - time)) %>% 
  slice(which.min(dif)) %>% 
  dplyr::select(IH_subjid,normalizacion,date.norm)

names(aux2) <- c("IH_subjid","M36_result_tac_followup___0","M36_date_tac_followup")
dat <- merge(dat,aux2,by="IH_subjid",all.x = TRUE)
```


```{r}

aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_result_tac_followup___1,M3_date_tac_followup,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., normalizacion = M3_result_tac_followup___1, date.norm = M3_date_tac_followup),
             dat %>% dplyr::select(IH_subjid,M6_result_tac_followup___1,M6_date_tac_followup,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., normalizacion = M6_result_tac_followup___1, date.norm = M6_date_tac_followup)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date.norm - AH_f_datehosp)))

aux2 <- aux %>% 
  group_by(IH_subjid) %>% 
  mutate( dif = abs(median(aux$time) - time)) %>% 
  slice(which.min(dif)) %>% 
  dplyr::select(IH_subjid,normalizacion,date.norm)

names(aux2) <- c("IH_subjid","M36_result_tac_followup___1","M36_date_tac_followup")
dat <- merge(dat,aux2 %>% dplyr::select(IH_subjid,M36_result_tac_followup___1),by="IH_subjid",all.x = TRUE)
```


```{r}

aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_result_tac_followup___2,M3_date_tac_followup,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., normalizacion = M3_result_tac_followup___2, date.norm = M3_date_tac_followup),
             dat %>% dplyr::select(IH_subjid,M6_result_tac_followup___2,M6_date_tac_followup,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., normalizacion = M6_result_tac_followup___2, date.norm = M6_date_tac_followup)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date.norm - AH_f_datehosp)))

aux2 <- aux %>% 
  group_by(IH_subjid) %>% 
  mutate( dif = abs(median(aux$time) - time)) %>% 
  slice(which.min(dif)) %>% 
  dplyr::select(IH_subjid,normalizacion,date.norm)

names(aux2) <- c("IH_subjid","M36_result_tac_followup___2","M36_date_tac_followup")
dat <- merge(dat,aux2 %>% dplyr::select(IH_subjid,M36_result_tac_followup___2),by="IH_subjid",all.x = TRUE)
```



```{r}

aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_result_tac_followup___3,M3_date_tac_followup,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., normalizacion = M3_result_tac_followup___3, date.norm = M3_date_tac_followup),
             dat %>% dplyr::select(IH_subjid,M6_result_tac_followup___3,M6_date_tac_followup,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., normalizacion = M6_result_tac_followup___3, date.norm = M6_date_tac_followup)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date.norm - AH_f_datehosp)))

aux2 <- aux %>% 
  group_by(IH_subjid) %>% 
  mutate( dif = abs(median(aux$time) - time)) %>% 
  slice(which.min(dif)) %>% 
  dplyr::select(IH_subjid,normalizacion,date.norm)

names(aux2) <- c("IH_subjid","M36_result_tac_followup___3","M36_date_tac_followup")
dat <- merge(dat,aux2 %>% dplyr::select(IH_subjid,M36_result_tac_followup___3),by="IH_subjid",all.x = TRUE)
```



```{r}

aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_result_tac_followup___4,M3_date_tac_followup,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., normalizacion = M3_result_tac_followup___4, date.norm = M3_date_tac_followup),
             dat %>% dplyr::select(IH_subjid,M6_result_tac_followup___4,M6_date_tac_followup,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., normalizacion = M6_result_tac_followup___4, date.norm = M6_date_tac_followup)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date.norm - AH_f_datehosp)))

aux2 <- aux %>% 
  group_by(IH_subjid) %>% 
  mutate( dif = abs(median(aux$time) - time)) %>% 
  slice(which.min(dif)) %>% 
  dplyr::select(IH_subjid,normalizacion,date.norm)

names(aux2) <- c("IH_subjid","M36_result_tac_followup___4","M36_date_tac_followup")
dat <- merge(dat,aux2 %>% dplyr::select(IH_subjid,M36_result_tac_followup___4),by="IH_subjid",all.x = TRUE)
```



```{r}

aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_result_tac_followup___5,M3_date_tac_followup,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., normalizacion = M3_result_tac_followup___5, date.norm = M3_date_tac_followup),
             dat %>% dplyr::select(IH_subjid,M6_result_tac_followup___5,M6_date_tac_followup,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., normalizacion = M6_result_tac_followup___5, date.norm = M6_date_tac_followup)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date.norm - AH_f_datehosp)))

aux2 <- aux %>% 
  group_by(IH_subjid) %>% 
  mutate( dif = abs(median(aux$time) - time)) %>% 
  slice(which.min(dif)) %>% 
  dplyr::select(IH_subjid,normalizacion,date.norm)

names(aux2) <- c("IH_subjid","M36_result_tac_followup___5","M36_date_tac_followup")
dat <- merge(dat,aux2 %>% dplyr::select(IH_subjid,M36_result_tac_followup___5),by="IH_subjid",all.x = TRUE)
```

```{r}

aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_result_tac_followup___6,M3_date_tac_followup,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., normalizacion = M3_result_tac_followup___6, date.norm = M3_date_tac_followup),
             dat %>% dplyr::select(IH_subjid,M6_result_tac_followup___6,M6_date_tac_followup,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., normalizacion = M6_result_tac_followup___6, date.norm = M6_date_tac_followup)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date.norm - AH_f_datehosp)))

aux2 <- aux %>% 
  group_by(IH_subjid) %>% 
  mutate( dif = abs(median(aux$time) - time)) %>% 
  slice(which.min(dif)) %>% 
  dplyr::select(IH_subjid,normalizacion,date.norm)

names(aux2) <- c("IH_subjid","M36_result_tac_followup___6","M36_date_tac_followup")
dat <- merge(dat,aux2 %>% dplyr::select(IH_subjid,M36_result_tac_followup___6),by="IH_subjid",all.x = TRUE)
```


```{r}

aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_followup_spirometry_fvc,M3_followup_spirometry_date,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., normalizacion = M3_followup_spirometry_fvc, date.norm = M3_followup_spirometry_date),
             dat %>% dplyr::select(IH_subjid,M6_followup_spirometry_fvc,M6_followup_spirometry_date,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., normalizacion = M6_followup_spirometry_fvc, date.norm = M6_followup_spirometry_date)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date.norm - AH_f_datehosp)))

aux2 <- aux %>% 
  group_by(IH_subjid) %>% 
  mutate( dif = abs(median(aux$time) - time)) %>% 
  slice(which.min(dif)) %>% 
  dplyr::select(IH_subjid,normalizacion,date.norm)

names(aux2) <- c("IH_subjid","M36_followup_spirometry_fvc","M36_followup_spirometry_date")
dat <- merge(dat,aux2 %>% dplyr::select(IH_subjid,M36_followup_spirometry_fvc),by="IH_subjid",all.x = TRUE)
```

```{r}

aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_followup_spirometry_fev,M3_followup_spirometry_date,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., normalizacion = M3_followup_spirometry_fev, date.norm = M3_followup_spirometry_date),
             dat %>% dplyr::select(IH_subjid,M6_followup_spirometry_fev,M6_followup_spirometry_date,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., normalizacion = M6_followup_spirometry_fev, date.norm = M6_followup_spirometry_date)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date.norm - AH_f_datehosp)))

aux2 <- aux %>% 
  group_by(IH_subjid) %>% 
  mutate( dif = abs(median(aux$time) - time)) %>% 
  slice(which.min(dif)) %>% 
  dplyr::select(IH_subjid,normalizacion,date.norm)

names(aux2) <- c("IH_subjid","M36_followup_spirometry_fev","M36_followup_spirometry_date")
dat <- merge(dat,aux2  %>% dplyr::select(IH_subjid,M36_followup_spirometry_fev),by="IH_subjid",all.x = TRUE)
```

```{r}

aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_followup_spirometry_fev_fvc,M3_followup_spirometry_date,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., normalizacion = M3_followup_spirometry_fev_fvc, date.norm = M3_followup_spirometry_date),
             dat %>% dplyr::select(IH_subjid,M6_followup_spirometry_fev_fvc,M6_followup_spirometry_date,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., normalizacion = M6_followup_spirometry_fev_fvc, date.norm = M6_followup_spirometry_date)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date.norm - AH_f_datehosp)))

aux2 <- aux %>% 
  group_by(IH_subjid) %>% 
  mutate( dif = abs(median(aux$time) - time)) %>% 
  slice(which.min(dif)) %>% 
  dplyr::select(IH_subjid,normalizacion,date.norm)

names(aux2) <- c("IH_subjid","M36_followup_spirometry_fev_fvc","M36_followup_spirometry_date")
dat <- merge(dat,aux2   %>% dplyr::select(IH_subjid,M36_followup_spirometry_fev_fvc),by="IH_subjid",all.x = TRUE)
```


```{r}


aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_exitus_followup,M3_followup_spirometry_date,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., normalizacion = M3_exitus_followup, date = M3_followup_spirometry_date),
             dat %>% dplyr::select(IH_subjid,M6_exitus_followup,M6_followup_spirometry_date,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., normalizacion = M6_exitus_followup, date = M6_followup_spirometry_date),
             dat %>% dplyr::select(IH_subjid,A1_exitus_followup_2,A1_followup_spirometry_date_3,AH_f_datehosp)
             %>% mutate(time = "A1") %>% 
               rename(., normalizacion = A1_exitus_followup_2, date = A1_followup_spirometry_date_3)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date - AH_f_datehosp)))




aux2 <- aux %>% 
  group_by(IH_subjid) %>% 
  mutate( dif = abs(median(aux$time) - time)) %>% 
  slice(which.min(dif)) %>% 
  dplyr::select(IH_subjid,normalizacion,date)

names(aux2) <- c("IH_subjid","M36_exitus_followup","M36_followup_spirometry_date")
dat <- merge(dat,aux2,by="IH_subjid",all.x = TRUE)
```


```{r}


aux <- rbind(dat %>% dplyr::select(IH_subjid,M3_admission_followup ,M3_followup_spirometry_date,AH_f_datehosp) %>% 
               mutate(time = "M3") %>%
               rename(., normalizacion = M3_admission_followup , date = M3_followup_spirometry_date),
             dat %>% dplyr::select(IH_subjid,M6_admission_followup ,M6_followup_spirometry_date,AH_f_datehosp)
             %>% mutate(time = "M6") %>% 
               rename(., normalizacion = M6_admission_followup , date = M6_followup_spirometry_date),
             dat %>% dplyr::select(IH_subjid,A1_admission_followup_2,A1_followup_spirometry_date_3,AH_f_datehosp)
             %>% mutate(time = "A1") %>% 
               rename(., normalizacion = A1_admission_followup_2, date = A1_followup_spirometry_date_3)) %>%
  filter(complete.cases(.)) %>%
  mutate(time = abs(as.numeric(date - AH_f_datehosp)))


aux2 <- aux %>% 
  group_by(IH_subjid) %>% 
  mutate( dif = abs(median(aux$time) - time)) %>% 
  slice(which.min(dif)) %>% 
  dplyr::select(IH_subjid,normalizacion,date)

names(aux2) <- c("IH_subjid","M36_admission_followup","M36_followup_spirometry_date")
dat <- merge(dat,aux2,by="IH_subjid",all.x = TRUE)
```

```{r}
dat <- dat %>% mutate(time = as.numeric(M36_followup_spirometry_date - AH_f_datehosp)/30.25)
dat_aux <- dat %>% filter(!is.na(M36_admission_followup) & time>0 & dat$time<13)

dat$included <- ifelse(!is.na(dat$M36_followup_dlco) & dat$time>0  & dat$time<13,"Included","Without followup")
# & (dat$time>0 & dat$time<7)
dat$time_discharge_follow <- as.numeric(dat$M36_followup_spirometry_date - dat$AH_f_datehosp)/30.25
```

```{r,}

describe(dat %>% filter(!is.na(M36_followup_spirometry_date) & !is.na(AH_f_datehosp) & (included == "Included")) %>% mutate(dif = as.numeric(M36_followup_spirometry_date - AH_f_datehosp)/30.25) %>% dplyr::select(dif)) %>% html()

ggplot(dat %>% filter(!is.na(M36_followup_spirometry_date) & !is.na(AH_f_datehosp) & (included == "Included")) %>% mutate(dif = as.numeric(M36_followup_spirometry_date - AH_f_datehosp)/30.25),aes(y = dif,x = "")) + geom_boxplot(outlier.shape = NA) + geom_jitter() +  scale_y_continuous(breaks=c(-10:15)) + ylab(" Time from discharge to short term follow-up (months)")

```


```{r}
dat <- dat %>% 
  mutate( PAFI_min = dat %>% dplyr::select(contains("PAFI")) %>% apply(.,1,function(x){ifelse(all(is.na(x)),NA,min(x,na.rm = TRUE))}),
          pao2_min = dat %>% dplyr::select(contains("pao2")) %>% apply(.,1,function(x){ifelse(all(is.na(x)),NA,min(x,na.rm = TRUE))}),
          paco2_max = dat %>% dplyr::select(contains("paco2")) %>% apply(.,1,function(x){ifelse(all(is.na(x)),NA,max(x,na.rm = TRUE))}),
          ph_min = dat %>% dplyr::select(contains("ph_")) %>% apply(.,1,function(x){ifelse(all(is.na(x)),NA,min(x,na.rm = TRUE))}),
          hco3_min = dat %>% dplyr::select(contains("hco3")) %>% apply(.,1,function(x){ifelse(all(is.na(x)),NA,min(x,na.rm = TRUE))}),
          oxy_vsorres_min = dat %>% dplyr::select(contains("oxy_vsorres")) %>% apply(.,1,function(x){ifelse(all(is.na(x)),NA,min(x,na.rm = TRUE))}))

dat <- dat %>%  mutate(
  M36_dlco_trend = ifelse(M36_followup_dlco<60,"<60",
                          ifelse(M36_followup_dlco<80,"60<x<80",">80")),
  M36_dlco_60 = ifelse(M36_followup_dlco<60,"<60",">60"),
  M36_dlco_80 = ifelse(M36_followup_dlco<80,"<80",">80"),
)


dat$AH_highflow_prdur[which(dat$AH_highflow_proccur == "No")] <- 0
dat$AH_invasive_prdur[which(dat$AH_invasive_proccur == "No")] <- 0
dat$AH_prone_prdur[which(dat$AH_pronevent_prtrt == "No")] <- 0
dat$AH_inotrop_prdur[which(dat$AH_inotrop_cmtrt == "No")] <- 0
dat$AH_ecmo_dur[which(dat$AH_extracorp_prdur == "No")] <- 0
dat$AH_antibiotic_cmdur_2[which(dat$AH_antibiotic_cmyn == "No")] <- 0
dat$AH_corticos_cmdur[which(dat$AH_corticost_cmyn == "No")] <- 0
dat$AH_tracheo_prtrt_duration[which(dat$AH_tracheo_prtrt == "No")] <- 0
dat$AH_inotrop_prdur[which(dat$AH_inotrop_cmtrt == "No")] <- 0
dat$AH_neuroblock_dur[which(dat$AH_neuroblock == "No")] <- 0
dat$AH_noninvaisve_prdur[which(dat$AH_noninvasive_proccur == "No")] <- 0

 dat$AH_ef_recman <- as.character(dat$AH_ef_recman)
 dat$AH_ef_recman[which(dat$AH_ef_recman == "Se desconoce")] <- "No"
 dat$AH_ef_recman <- factor(dat$AH_ef_recman)

dat <- dat %>% mutate_if(is.character,function(x){ifelse(x == "Se desconoce",NA,x)})
dat <- dat %>% mutate_if(is.factor,function(x){ x = as.character(x); factor(ifelse(x == "Se desconoce",NA,x))})

dat$M36_dlco_trend <- factor(dat$M36_dlco_trend,levels = levels(factor(dat$M36_dlco_trend))[c(2,3,1)])

dat$D3_time <- ifelse((dat$D3_3d_ingreso_uci_validated > dat$IV_mv_datestart_validated), as.numeric( (dat$D3_3d_ingreso_uci_validated - dat$IV_mv_datestart_validated)),NA)
```


# Baseline characteristics of the cohort according to information available in follow-up visit.

```{r}
vec_names_bas <- dat %>%  dplyr::select(IH_age_estimateyears, IH_sex, IH_IMC, IH_smoking_mhyn, IH_ia_alcohol, IH_ia_drug_all, 
                                    IH_chroniccard_mhyn:IH_otherrisktext,
                                    IU_APACHE, IU_SOFA, IU_SOFAh, IU_SOFAr,IU_PAFI, IU_ef_resp_daily, IU_ef_ifo2_daily:IU_oxy_vsorres_daily, 
                                    IU_haemoglobin:IU_cardbnp,syn_ICU_time,Hosp_ICU_time,AH_antibiotic_cmyn,AH_antiviral_cmtrt___2,AH_antiviral_cmtrt___7,AH_ef_convales,AH_heparint_cmyn,AH_antiviral_cmtrt___6,AH_corticost_cmyn,AH_highflow_proccur,AH_noninvasive_proccur,AH_invasive_proccur,AH_pronevent_prtrt,AH_extracorp_prdur,AH_f_alive28,AH_f_deathsite,AH_invasive_prdur,AH_hodur,estacia_Hospital,syn_HOSP_time,Hosp_ICU_time,ICU_IMV_time,AH_outcomes,AH_ef_recman) %>%  names

res <- compareGroups( included~., data = dat  %>% dplyr::select(vec_names_bas,included),
                      method = NA, 
                      include.miss = FALSE)
tab <- createTable(res,show.all=T, show.n = TRUE, hide.no = "0")
export2md(tab)
export2xls(tab,"Included.xlsx")
```




```{r}
dat <- dat %>%  filter(included == "Included")

dat$included_last_study <- !is.na(dat$ID.TRRM)
```



```{r, create long data}

vec_events <- c("IV_","D3_","FV_") 
vec_param <- dat %>% 
  dplyr::select(IH_daily_dsstdat,IH_ef_ifo2_daily:IH_cardbnp,IH_filtrado,IH_daily_dsstdat_daily:IH_neuroblock_daily, IV_ef_resp, IV_VTweight, IV_VRatio, IV_compliance, IV_lymphocyte,IV_ef_peep, IV_ef_airplat, IV_DPress, IV_ef_airpeak) %>%  
  names %>%  
  gsub("^IH_","",.) %>% gsub("^IV_","",.)

dat_long <- lapply(vec_param,function(x){ 
  dat %>% 
    dplyr::select(IH_subjid,paste0(vec_events,x)) %>% 
    gather(key = time, value = !!eval(x), paste0(vec_events,x)) %>% 
    mutate(time = substring(time,1,2))
  }) %>%  
  reduce(inner_join,by=c("IH_subjid","time"))


# vec_events <- c("IH_","IU_","IV_","D3_","FV_")
# vec_param <- dat %>% 
#   dplyr::select(IH_daily_dsstdat_daily:IH_neuroblock_daily,IH_filtrado) %>%  
#   names %>%  
#   gsub("^IH_","",.)
# 
# dat_long_VMI <- lapply(vec_param,function(x){ 
#   dat %>% 
#     dplyr::select(IH_subjid,paste0(vec_events,x)) %>% 
#     gather(key = time, value = !!eval(x), paste0(vec_events,x)) %>% 
#     mutate(time = substring(time,1,2))
#   }) %>%  
#   reduce(inner_join,by=c("IH_subjid","time"))

```




# Lista de hospitales 

```{r}
DT::datatable(data.frame(table(dat$IH_sitename[dat$RedCap %in% miR$RedCap])) %>%  arrange(desc(Freq)), extensions = "Buttons", options = list(pageLength = 60, dom = "Bftip", buttons = c("copy", "csv", "excel", "pdf")))

```






# Comparativa DLCO


## Baseline characteristics of the cohort according DLCO at follow-up visit.


```{r}

dat$AH_corticost_cmtrt_cat <- ifelse(as.character(dat$AH_corticost_cmtrt) %in% c("Hidrocortisona","Betametasona","Parametasona","Prednisolona","Prednisona","Fludrocortisona"),"others",as.character(dat$AH_corticost_cmtrt))
dat$AH_corticost_cmtrt_2_cat <- ifelse(as.character(dat$AH_corticost_cmtrt_2) %in% c("Hidrocortisona","Betametasona","Parametasona","Prednisolona","Prednisona","Fludrocortisona"),"others",as.character(dat$AH_corticost_cmtrt_2))

dat$AH_corticost_cmtrt_cat_bis <-  paste0(dat$AH_corticost_cmtrt_2_cat," - ", dat$AH_corticost_cmtrt_cat)
dat$AH_corticost_cmtrt_cat_bis <- ifelse(dat$AH_corticost_cmtrt_cat_bis %in% c("Dexametasona - Metilprednisolona","Metilprednisolona - Dexametasona"),
                                         "both",
                                         ifelse(dat$AH_corticost_cmtrt_cat_bis %in% c("Dexametasona - Dexametasona","Dexametasona - others", "NA - Dexametasona", "others - Dexametasona"),
                                                "Dexametasona",
                                                ifelse(dat$AH_corticost_cmtrt_cat_bis %in% c("Metilprednisolona - Metilprednisolona","others - Metilprednisolona","NA - Metilprednisolona","Metilprednisolona - NA"),
                                                       "Metilprednisolona",
                                                       ifelse(dat$AH_corticost_cmtrt_cat_bis %in% c("others - others", "NA - others"),
                                                              "Others",
                                                              NA))))
dat$AH_corticost_cmddexa_total <-  apply(dat[,c("AH_corticost_cmddexa", "AH_corticost_cmddexa_2")],1,function(x){mean(x,na.rm=TRUE)})
dat$AH_corticost_cmddexa_dexa <- ifelse(dat$AH_corticost_cmtrt_cat == "Dexametasona", dat$AH_corticost_cmddexa, NA)
dat$AH_corticost_cmddexa_meti <- ifelse(dat$AH_corticost_cmtrt_cat == "Metilprednisolona", dat$AH_corticost_cmddexa, NA)
dat$AH_corticost_cmddexa_other <- ifelse(dat$AH_corticost_cmtrt_cat == "others", dat$AH_corticost_cmddexa, NA)

dat$AH_corticost_cmddexa_dexa_2 <- ifelse(dat$AH_corticost_cmtrt_2_cat == "Dexametasona", dat$AH_corticost_cmddexa_2, NA)
dat$AH_corticost_cmddexa_meti_2 <- ifelse(dat$AH_corticost_cmtrt_2_cat == "Metilprednisolona", dat$AH_corticost_cmddexa_2, NA)
dat$AH_corticost_cmddexa_other_2 <- ifelse(dat$AH_corticost_cmtrt_2_cat == "others", dat$AH_corticost_cmddexa_2, NA)
dat$AH_corticost_cmddexa_dexa <-  apply(dat[,c("AH_corticost_cmddexa_dexa", "AH_corticost_cmddexa_dexa_2")],1,function(x){mean(x,na.rm=TRUE)})
dat$AH_corticost_cmddexa_meti <-  apply(dat[,c("AH_corticost_cmddexa_meti", "AH_corticost_cmddexa_meti_2")],1,function(x){mean(x,na.rm=TRUE)})
dat$AH_corticost_cmddexa_other <-  apply(dat[,c("AH_corticost_cmddexa_other", "AH_corticost_cmddexa_other_2")],1,function(x){mean(x,na.rm=TRUE)})

dat$AH_corticost_cmddexa_dexa[is.nan(dat$AH_corticost_cmddexa_dexa)] <- NA
dat$AH_corticost_cmddexa_meti[is.nan(dat$AH_corticost_cmddexa_meti)] <- NA
dat$AH_corticost_cmddexa_other[is.nan(dat$AH_corticost_cmddexa_other)] <- NA


vec_names_bas <- dat %>%  dplyr::select(IH_age_estimateyears, IH_sex, IH_IMC, IH_smoking_mhyn, IH_ia_alcohol, IH_ia_drug_all, 
                                    IH_chroniccard_mhyn:IH_otherrisktext,
                                    IU_APACHE, IU_SOFA, IU_SOFAh, IU_SOFAr,IU_PAFI, IU_ef_resp_daily, IU_ef_ifo2_daily:IU_oxy_vsorres_daily, 
                                    IU_haemoglobin:IU_cardbnp,syn_ICU_time,Hosp_ICU_time,AH_antibiotic_cmyn,AH_antiviral_cmtrt___2,AH_antiviral_cmtrt___7,AH_ef_convales,AH_heparint_cmyn,AH_antiviral_cmtrt___6,AH_corticost_cmyn,AH_highflow_proccur,AH_noninvasive_proccur,AH_invasive_proccur,AH_pronevent_prtrt,AH_extracorp_prdur,AH_f_alive28,AH_f_deathsite,AH_invasive_prdur,AH_hodur,estacia_Hospital,syn_HOSP_time,Hosp_ICU_time,ICU_IMV_time,AH_outcomes,M36_dlco_80, IH_IMC_cat,AH_antiviral_cmyn,AH_prone_prdur,AH_ef_recman, AH_bactpneu_ceterm, AH_ards_ceterm, AH_pulmemb_ceterm, AH_bacteraemia_ceterm, AH_renalinjury_ceterm, AH_liverdysfunction_ceterm, AH_hyperglycemia_aeterm, AH_ef_infyn, PAFI_min,pao2_min,paco2_max,ph_min,hco3_min, IV_ef_ifo2_daily, IV_VTweight,IV_VRatio, IV_compliance, IV_lymphocyte, IV_ef_peep, IV_ef_airplat,IV_DPress, IV_ef_airplat,IV_ef_airpeak,AH_corticost_cmtrt_cat_bis,AH_corticost_cmddexa_dexa,AH_corticost_cmddexa_meti,AH_corticost_cmddexa_other,AH_heparin_prophylaxis___0,AH_heparin_prophylaxis___1,AH_heparin_prophylaxis___2,AH_vap_ceterm) %>%  names


res <- compareGroups( M36_dlco_80~., data = dat  %>% dplyr::select(vec_names_bas,included),
                      method = NA, 
                      include.miss = FALSE)
tab <- createTable(res,show.all=T, show.n = TRUE, hide.no = "0")
export2md(tab)
export2xls(tab,"09_results/Tabla_basal.xlsx")
```

## Tabla función pulmonar en funcion de DLCO 

```{r}

vec_names_bas <- dat %>%  dplyr::select(M36_dlco_80,M36_followup_dlco, M36_followup_spirometry_fev, M36_followup_spirometry_fvc, M36_followup_spirometry_fev_fvc, M36_result_tac_followup___1, M36_result_tac_followup___5, M36_result_tac_followup___4, M36_result_tac_followup___3 ) %>%  names


res <- compareGroups( M36_dlco_80~., data = dat  %>% dplyr::select(vec_names_bas,included),
                      method = 2, 
                      include.miss = FALSE)
tab <- createTable(res,show.all=T, show.n = TRUE, hide.no = "0")
export2md(tab)
export2xls(tab,"09_results/Tabla_secuelas_respiratorias.xlsx")

```

## Quality Control of miRNAs

### Raw data 

```{r}
DT::datatable(dat %>% dplyr::select(RedCap,ID.TRRM,miR.132.3p:miR.98.5p), extensions = "Buttons", options = list(pageLength = 20, dom = "Bftip", buttons = c("copy", "csv", "excel", "pdf")))
```

### PCA QC

```{r,eval=FALSE}

do = "analyze"
method = "euclidean"
type = "median"
coef = 1.5
labels = FALSE

    dat$Group <- factor(dat$exitus)
    groups <-  dat$Group
    names <- dat$RedCap
    to_outliers <- dat %>% dplyr::select(miR.132.3p:miR.98.5p) 
    dd <- dist(to_outliers, method = method)
    distances <- vegan::betadisper(dd, groups, type = type, bias.adjust = FALSE, 
        sqrt.dist = FALSE, add = FALSE)
    detect_outliers <- data.frame(distances = distances$distances, 
        Groups = distances$group, sample = names)
    limit <- data.frame(aggregate(detect_outliers$distances, 
        list(detect_outliers$Groups), function(x) {
            quantile(x, 0.75) + coef * IQR(x)
        }))
    colnames(limit)[1] <- "Groups"
    detect_outliers <- merge(detect_outliers, limit, by = "Groups")
    detect_outliers <- detect_outliers %>% mutate(out = as.factor(ifelse(distances > 
        x, 1, 0)))
    final_outliers <- detect_outliers %>% filter(out == 1) %>% 
        dplyr::select(sample, Groups, distances, x) %>% rename(group = Groups, 
        distance_to_centroid = distances, limit_distance = x)
    if (do == "analyze") {
        vectors <- data.frame(distances$vectors)
        centroids <- data.frame(distances$centroids)
        total_outliers <- vectors %>% tibble::rownames_to_column("sample") %>% 
            mutate(Group = groups)
        find_hull <- function(x) {
            x[chull(x$PCoA1, x$PCoA2), ]
        }
        hulls <- total_outliers %>% dplyr::select(-sample) %>% group_by(Group) %>% 
            dplyr::do(find_hull(.))
        polygon_plot <- ggplot(total_outliers, aes(x = PCoA1, 
            y = PCoA2)) + geom_polygon(data = hulls, alpha = 0.5, 
            aes(fill = Group)) + {
            if (!labels) 
                geom_point(aes(shape = Group), size = 3, alpha = 0.7)
        } + geom_label(data = centroids, aes(x = PCoA1, y = PCoA2, 
            color = rownames(centroids), label = rownames(centroids)), 
            show.legend = FALSE) + {
            if (labels) 
                geom_text(aes(label = sample))
        } + theme_bw()
        distance_boxplot <- ggplot(detect_outliers, aes(Groups, 
            distances, fill = Groups)) + geom_boxplot(coef = coef, 
            alpha = 0.8) + ylab("Distance to group centroid") + 
            xlab("") + {
            if (labels) 
                ggrepel::geom_label_repel(data = detect_outliers[detect_outliers$out == 
                  1, ], aes(label = sample), na.rm = TRUE, size = 4, 
                  show.legend = FALSE)
        } + theme_bw() + theme(axis.text.x = element_text(angle = 45, 
            hjust = 1))
    
           # return(list(polygon_plot = polygon_plot, distance_boxplot = distance_boxplot, 
           #     outliers = final_outliers))
    }
    
polygon_plot
final_outliers
```


```{r}
#dat <- dat %>% dplyr::select(-miR.23a.3p,-miR.21.5p) 
dat$IU_platelet[dat$IU_platelet>1000] <- NA

```


### miRNAs eliminados

```{r}
#drop.cols <- c("miR.491.5p","miR.199a.5p","miR.27b.3p","miR.214.3p","miR.148a.3p","miR.27a.3p")
drop.cols <- c("miR.23a.3p","miR.21.5p")


library(ggplot2)
library(colorspace)

aux2 <- dat %>% dplyr::select(M36_dlco_80,drop.cols)
aux2$M36_dlco_80 <- factor(aux2$M36_dlco_80)
sas=reshape::melt(aux2)
sas$variable <- gsub("\\.", "-",sas$variable)
colnames(sas)<- c("M36_dlco_80","variable","value")

#sas$value <- 10^sas$value

p <-  ggplot(sas,aes(x=M36_dlco_80,y =  value,fill = M36_dlco_80))  +   
 geom_violin(outlier.shape = NA)+ geom_jitter(size = 1.5,width = 0.2)+
#  geom_boxplot(width=0.2, alpha = 0.1,lwd=1.5) + 
 # geom_boxplot(outlier.shape = NA) + geom_jitter(size = 1.5,width = 0.2)+
 # geom_jitter(width = 0.2,size=0.1)+
  scale_fill_manual(values = c("#008F9C","#6B327C"),labels = c("<80", ">80"))+
  #scale_color_manual(values = rainbow_hcl(4))+
  theme_bw()  + 
    theme(
      strip.text = element_text(size=16), 
      axis.text.x=element_text(angle = 90, hjust=1), axis.ticks.x=element_blank(),
        axis.text.y=element_text(size = 12), axis.title.y = element_text(size=20),
        axis.title.x=element_blank(),
      axis.text=element_text(size=0, colour="black"),
        plot.title=element_text(size=18, face="bold"),
      legend.key.size = unit(1.5, "cm"),
  legend.key.width = unit(1.5,"cm"),
  legend.title = element_blank(),
  legend.position = "bottom",
  legend.text = element_text(size=18))+
facet_grid( ~   variable) +
  xlab("")+ 
  ylab(expression(log[10]*2^{-Delta*Cq})) + coord_cartesian(ylim=c(1.75,7)) 

pdf("09_results/Figura_dotplot_No_sentido_discovery.pdf",width = 14,height = 10)
p 
dev.off()
p




pdf("09_results/Figura_dotplot_No_sentido_discovery.pdf",width = 15,height = 6)

ggplot(sas , aes(variable, value, fill = M36_dlco_80)) +
  introdataviz::geom_split_violin(alpha = .4, trim = FALSE) +
  geom_boxplot(width = .2, alpha = .6, fatten = NULL, show.legend = FALSE) +
  stat_summary(fun.data = "mean_se", geom = "pointrange", show.legend = F, 
               position = position_dodge(.175)) +
#  scale_x_discrete(name = "Condition", labels = c("Non-word", "Word")) +
 # scale_y_continuous(name = "Reaction time (ms)",
  #                   breaks = seq(200, 800, 100), 
  #                   limits = c(200, 800)) +
 # scale_fill_brewer(palette = "Dark2", name = "M36_dlco_80") +
  theme_minimal() + scale_fill_manual( name = " ",values = c("#008F9C","#6B327C"),labels = c("<80", ">80"))  + coord_cartesian(ylim=c(1.75,10)) + xlab("")+ 
  ylab(expression(log[10]*2^{-Delta*Cq})) + coord_cartesian(ylim=c(1,9)) +    
  theme(plot.background = element_rect(color = 1, size = 1),
        plot.margin = margin(t = 1,  # Top margin
                             r = 1,  # Right margin
                             b = 3,  # Bottom margin
                             l = 2,  # Left margin
                             unit = "cm")) 
dev.off()












dat <- dat %>% dplyr::select(!drop.cols)

```

## Expresion Diferencial 

### Expresion diferencial en tendencia 

```{r}

vec_names_bas <- dat %>%  dplyr::select(M36_dlco_trend,miR.132.3p:miR.98.5p) %>%  names


res <- compareGroups( M36_dlco_trend~., data = dat  %>% dplyr::select(vec_names_bas),
                      method = 1, 
                      include.miss = FALSE)
tab <- createTable(res,show.all=T, show.p.trend = T, show.n = TRUE, hide.no = "0")
export2md(tab)

```


### Differential expression Adjusted by AGE + SEXO + HTA + PUL + RENAL + OBESITY +  DIABETES

```{r}
dat$IH_sex <- factor(dat$IH_sex)
miRnames <- dat %>% dplyr::select(miR.132.3p:miR.98.5p) %>% names()
dat$M36_dlco_80.f <- relevel(factor(dat$M36_dlco_80),ref = ">80") 
res_de <- expresion_diferencial(dat, "M36_dlco_80.f",c("IH_age_estimateyears","IH_sex","IH_hypertension_mhyn","IH_chronicpul_mhyn","IH_renal_mhyn","IH_obesity_mhyn","IH_diabetes_mhyn_2"), miRnames,"RedCap",base = 10)
DE <- res_de[[2]][which((res_de[[2]]$FC>1.25 | res_de[[2]]$FC<0.8) & res_de[[2]]$p.value <0.05),"Names"]
DE_plasma <- DE
```


#### Table

<div class="blue">

```{r}
x_plasma <- res_de[[2]]
datatable(x_plasma, 
          extensions = 'Buttons', 
          filter = 'none', 
          options = list(columnDefs = list(list(className = 'dt-center', targets = 1:2)),
                         pageLength = nrow(x_plasma), 
                         dom = 'Btr', scrollX = TRUE, scrollY = "300px", 
                         deferRender = TRUE, scroller = TRUE, 
                         buttons = list(
                           list(extend = 'csv', filename = "descriptive"),
                           list(extend = 'excel', filename = "descriptive"),
                           list(extend = 'pdf', filename = "descriptive"),
                           'print'), 
                         ordering = F, language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/English.json')), 
          escape = F,  
          colnames = colnames(x_plasma), caption = "Adjusted (AGE + SEXO + HTA + PUL + RENAL + OBESITY +  DIABETES) Differential Expression with Limma")

xlsx::write.xlsx(x_plasma,file = "09_results/Expresion_diferencial_con_confusoras.xlsx",row.names = FALSE)
```

</div>

</br>

#### Volcano plot

`r DE`

```{r}
res_de[[3]] + xlim(-0.4,0.4)
```

### Differential expression unadjusted

#### Table 

```{r}
class = dat$M36_dlco_80.f

#if(adjuted == "unadjusted"){
design <- model.matrix(~0+class)
colnames(design) <- c("vive","muere")
rownames(design) <- dat$RedCap
cont.matrix <- makeContrasts(DIF = muere-vive, levels=design)  

# if(adjuted == "adjusted"){
# design <- model.matrix(~ AGE + SEXO + class)
# colnames(design) <- c("INTERCEPT","AGE","SEXO","Positive")
# rownames(design) <- phenodata$Sample.Name
# cont.matrix <- makeContrasts(Positive, levels=design)
# }
aux <- t(dat %>% dplyr::select(miR.132.3p:miR.98.5p))

rownames(aux) <- colnames(dat %>% dplyr::select(miR.132.3p:miR.98.5p))
lmF <- lmFit(aux, design)

## definir los contrastes ##

cont.fit <- contrasts.fit(lmF, cont.matrix)
eBa <- eBayes(cont.fit)

#topTable(eBa,adjust.method = "fdr")
write.fit(eBa, file="07_Data/limma_aux.txt", adjust="fdr")

## Obtenci?n de la tabla de resultados con los 2^-ddCt y los p-values ##
limma <- read.table(file="07_Data/limma_aux.txt", header = TRUE, sep = "\t", dec = ".")
colnames(limma) <- c("miRNAs","Amean","Coef","t","p.value","p.value.adj","F","F.pvalue")
# ddCt <- data.frame(featureNames(qPCRBatch.dCq2),2^(-limma$Coef),limma$p.value,limma$p.value.adj,flags,complet,prop_na_casos,prop_na_controles)
# colnames(ddCt) <- c("Gene_ID","Fold_Change","p.value","p-value_adj.","+NAs","COMPLETOS","NA_CASOS","NA_controles")

#ddCt <- data.frame(rownames(aux),2^(-limma$Coef),limma$p.value,limma$p.value.adj)
ddCt <- data.frame(limma$miRNAs,10^(limma$Coef),limma$p.value,limma$p.value.adj)
colnames(ddCt) <- c("Gene_ID","Fold_Change","p.value","FDR")

# Claculate AUC 

aux <- data.frame(dat %>% dplyr::select(miR.132.3p:miR.98.5p))
res <- apply(aux,2,function(x){auc(dat$M36_dlco_80, x)})
res <- ifelse(res<0.5,1-res,res)
res <- data.frame(Gene_ID =names(res),AUC = res)
ddCt <- merge(ddCt,res,by = "Gene_ID")
ddCt$Gene_ID <- gsub("\\.","-",ddCt$Gene_ID)
#Reordenaci?n de la tabla de resultados ddCt
ddCt <- ddCt[order(ddCt$p.value, decreasing=FALSE),]

DT::datatable(ddCt, extensions = "Buttons", options = list(pageLength = 20, dom = "Bftip", buttons = c("copy", "csv", "excel", "pdf")), caption = "Differentially expressed") %>% DT::formatRound(names(ddCt)[-1], 4)

ddCt$Gene_ID <- gsub("-","\\.",ddCt$Gene_ID)

xlsx::write.xlsx(ddCt,file = "09_results/Expresion_diferencial_sin_confusoras.xlsx",row.names = FALSE)


#DE <- ddCt[which((ddCt$FC>1.25 | ddCt$FC<0.8) & ddCt$p.value <0.05),"Names"]
```

#### Volcano plot

```{r}
# volcanoplot2(eBa, highlight = table(ddCt$p.value < 0.05)["TRUE"], names = rownames(eBa), pch = 18, cex = 1.2, xlim = c(-0.6, 0.5))
# abline(h = -log10(0.05), lty = 2)

cols <- c("Downregulated" = "red", "Nonsignificant" = "black", "Upnregulated" = "blue")
ss <- data.frame(x=eBa$coefficients[,1], y=c(-1)*log(eBa$p.value[,1]),names = rownames(eBa$lods))
ss$color <- ifelse(ss$y > 2.302585 & ss$x < c(-0.06069784),"Downregulated",
                   ifelse(ss$y >= c(2.302585) & ss$x > 0.06069784 ,"Upnregulated","Nonsignificant"))
#cairo_pdf("Olink post-covid/09_results/Volcano.pdf",width = 12,height = 10)
bp <- ggplot(ss, aes(x = x, y = y, labels=names,color = color)) + geom_point(size = 2.5, alpha = 1, na.rm = T)  +   
  scale_colour_manual(values = cols) +
  ggtitle(label = "", subtitle = "") +
  geom_point(size = 2.5, alpha = 1, na.rm = T) +
  theme_bw(base_size = 14) + 
  theme(legend.position = "top",
        legend.title = element_blank(),
        axis.text=element_text(size=23),
        axis.title=element_text(size=23,face="bold"),
        legend.text = element_text(size=23)) + 
  xlab(expression(ln("Fold Change"))) + 
  ylab(expression(-ln("p value"))) + 
  geom_hline(yintercept = 2.302585, colour="#990000", linetype="dashed") + 
  geom_vline(xintercept = -0.06069784, colour="#990000", linetype="dashed") + 
  geom_vline(xintercept = 0.06069784, colour="#990000", linetype="dashed") +
scale_y_continuous(trans = "log1p") + xlim(-0.4,0.4) + ggrepel::geom_text_repel(aes(x = x, y = y, label=names))
bp
#dev.off()
```


```{r}
miRNAs <- ddCt$Gene_ID
```


#### Figure dotplot 

```{r,fig.height=20, fig.height=25}
library(ggplot2)
library(colorspace)

aux2 <- dat %>% dplyr::select(M36_dlco_80,miR.132.3p:miR.98.5p)
aux2$M36_dlco_80 <- factor(aux2$M36_dlco_80)
sas=reshape::melt(aux2)
sas=merge(sas,ddCt,by.x = "variable",by.y = "Gene_ID")
sas$variable <- gsub("hsa-", "",sas$variable)
colnames(sas)<- c("variable","M36_dlco_80","value","FoldChange","pvalue","pvalue.adj","UCI")
sas <- sas %>% filter(complete.cases(.))
#sas$variable <- factor(sas$variable, levels = levels(factor(sas$variable))[c(3,8,9,10,1,2,4,5,6,7)])

pdf("09_results/Figura_dotplot.pdf",width = 15,height = 5)

ggplot(sas, aes(variable, value, fill = M36_dlco_80)) +
  introdataviz::geom_split_violin(alpha = .4, trim = FALSE) +
  geom_boxplot(width = .2, alpha = .6, fatten = NULL, show.legend = FALSE) +
  stat_summary(fun.data = "mean_se", geom = "pointrange", show.legend = F, 
               position = position_dodge(.175)) +
#  scale_x_discrete(name = "Condition", labels = c("Non-word", "Word")) +
 # scale_y_continuous(name = "Reaction time (ms)",
  #                   breaks = seq(200, 800, 100), 
  #                   limits = c(200, 800)) +
 # scale_fill_brewer(palette = "Dark2", name = "M36_dlco_80") +
  theme_minimal() + scale_fill_manual( name = " ",values = c("#008F9C","#6B327C"),labels = c("<80", ">80"))  + coord_cartesian(ylim=c(1.75,10)) + xlab("")+ 
  ylab(expression(log[10]*2^{-Delta*Cq})) + coord_cartesian(ylim=c(0,12)) +    
  theme(plot.background = element_rect(color = 1, size = 1),
        plot.margin = margin(t = 1,  # Top margin
                             r = 1,  # Right margin
                             b = 3,  # Bottom margin
                             l = 2,  # Left margin
                             unit = "cm")) 
dev.off()


ggplot(sas, aes(variable, value, fill = M36_dlco_80)) +
  introdataviz::geom_split_violin(alpha = .4, trim = FALSE) +
  geom_boxplot(width = .2, alpha = .6, fatten = NULL, show.legend = FALSE) +
  stat_summary(fun.data = "mean_se", geom = "pointrange", show.legend = F, 
               position = position_dodge(.175)) +
#  scale_x_discrete(name = "Condition", labels = c("Non-word", "Word")) +
 # scale_y_continuous(name = "Reaction time (ms)",
  #                   breaks = seq(200, 800, 100), 
  #                   limits = c(200, 800)) +
 # scale_fill_brewer(palette = "Dark2", name = "M36_dlco_80") +
  theme_minimal() + scale_fill_manual( name = " ",values = c("#008F9C","#6B327C"),labels = c("<80", ">80"))  + coord_cartesian(ylim=c(1.75,10)) + xlab("")+ 
  ylab(expression(log[10]*2^{-Delta*Cq})) + coord_cartesian(ylim=c(0,12)) +    
  theme(plot.background = element_rect(color = 1, size = 1),
        plot.margin = margin(t = 1,  # Top margin
                             r = 1,  # Right margin
                             b = 3,  # Bottom margin
                             l = 2,  # Left margin
                             unit = "cm")) 
```

## SCORE 

### LASSO 

```{r}


library(glmnet)
#dat[complete.cases(dat[,c(miRNAs,clinical_var),]

# for(i in paste0(mir.all,".cat")){
#   dat[,i] <- relevel(dat[,i], ref = "High")
# }
#   
x <- dat[,miRNAs]
x <- makeX(x,na.impute = TRUE)
x <- x[,seq(from = 1,to = 16,by = 2)]
#rownames(x) <- dat[which(dat$follow>0),"RedCap"]
y <-ifelse(dat[,"M36_dlco_80"] == ">80",0,1)



# LASSO Optimo

set.seed(1)
lasso_model <- cv.glmnet(x, y,  alpha=1, family = "binomial",standardize = FALSE,relax = TRUE,nfolds = 5)
plot(lasso_model)

set.seed(1)                                # replicate  results
lasso_model <- glmnet(x, y, alpha=1,  family = "binomial",gamma = lasso_model$relaxed$gamma.min, lambda = lasso_model$relaxed$lambda.min,standardize = FALSE,relax = TRUE) 

library(data.table)
best_lambda_lasso <- lasso_model$lambda  # largest lambda in 1 SE
lasso_coef <- lasso_model$beta
coef_l = data.table(lasso = lasso_coef[,1])      # build table
coef_l[, feature := rownames(lasso_coef)]       # add feature names
to_plot_l = melt(coef_l                      # label table
                 , id.vars='feature'
                 , variable.name = 'model'
                 , value.name = 'coefficient')

#cairo_pdf("Figure_Lasso_2_NOSA.pdf",width = 12,height = 6)
#pdf(file = "09_results/LASSO.pdf",height = 3,width = 6)
library(forcats)
ggplot(data = to_plot_l %>% filter(coefficient != 0) %>% mutate(feature =  fct_reorder(feature,coefficient)),    # plot coefficients
       aes(x=feature, y=coefficient, fill=feature,  color = feature)) +
    coord_flip() +         
    geom_bar(stat='identity',width = 0.5) +
  #  facet_wrap(~ model) + guides(fill=FALSE) + 
      theme_minimal(base_size = 18) + ylab("LASSO regression coefficient") + xlab(" ") + scale_color_manual(values =  c("#BFBFFF","#A3A3FF","#7879FF","#4949FF"))+ scale_fill_manual(values = c("#BFBFFF","#A3A3FF","#7879FF","#4949FF")) + theme(legend.position = "none")
#dev.off()

# ggplot(data = to_plot_l %>% filter(coefficient != 0) %>% mutate(feature =  fct_reorder(feature,coefficient)),    # plot coefficients
#        aes(x=feature, y=coefficient, fill=feature,  color = feature)) +
#     coord_flip() +         
#     geom_bar(stat='identity',width = 0.5) +
#   #  facet_wrap(~ model) + guides(fill=FALSE) + 
#       theme_minimal(base_size = 18) + ylab("LASSO regression coefficient") + xlab(" ") + scale_color_manual(values =  c("#BFBFFF","#A3A3FF","#7879FF","#4949FF"))+ scale_fill_manual(values = c("#BFBFFF","#A3A3FF","#7879FF","#4949FF")) + theme(legend.position = "none")

if(dim(to_plot_l[which(to_plot_l$coefficient != 0),"feature"])[1] !=0){
mod <- glm(as.formula(paste0("I(exitus == 1)~ ",paste(gsub("Low","",c(to_plot_l[which(to_plot_l$coefficient != 0),"feature"])$feature),collapse = "+"),"")) , family = "binomial", dat )
summary(mod)
}
```

### Random forest

```{r, comment="",fig.width=20,fig.height=25}
# Variables importance 
# varselect.pred: A vector of variables selected after "prediction step"

## Seleccion de variables 
dat.s <- dat %>% dplyr::select(miRNAs,M36_dlco_80.f) %>% filter(complete.cases(.))

# Listado variables
knitr::combine_words(c("Listado de variables utilizadas:", names(dat.s)))

library(VSURF)
set.seed(12)
vsel<-VSURF(dat.s[,1:(dim(dat.s)[2] - 1)], factor(dat.s[,dim(dat.s)[2]]),verbose = FALSE)
# triga alguns minuts

sel_pred <- colnames(dat.s[,1:(dim(dat.s)[2] - 1)])[vsel$varselect.pred]
sel_thres <- colnames(dat.s[,1:(dim(dat.s)[2] - 1)])[vsel$varselect.thres]

#sel_pred

#imp.mean.dec: A vector of the variables importance means, in decreasing order.
#imp.mean.dec.ind: The ordering index vector associated to the sorting of variables importance means.

var_importance <- data.frame(IV = vsel$imp.mean.dec, 
                             var_name = colnames(dat.s[,1:(dim(dat.s)[2] - 1)])[vsel$imp.mean.dec.ind])
var_importance <-  var_importance[order(var_importance$IV),]
var_importance  <- var_importance[var_importance$var_name %in% sel_thres,]
p <- ggplot(var_importance, aes(x=reorder(var_name, +IV), weight=IV, fill=IV))
p <- p + geom_bar()
p <- p + xlab("") + ylab("Variable Importance")
p <- p + viridis::scale_fill_viridis(direction = -1, option = "D")
p <- p + theme_bw()  + theme(axis.text.x=element_text(size=8),
          axis.text.y=element_text(size=8),
          axis.title=element_text(size=16),
          plot.title=element_text(size=18),
          legend.title=element_text(size=16),
          legend.text=element_text(size=15),
          legend.position = "none")
p <- p +  coord_flip()


#gg_des <- colorblindr::edit_colors(p, desaturate)
#cowplot::ggdraw(gg_des)


# err.pred: A vector of the mean out-of-bag (OOB) error rates of the random forests models build during the "prediction step".

var_error <- data.frame(Error = vsel$err.pred, prot = colnames(dat.s[,1:(dim(dat.s)[2] - 1)])[vsel$varselect.pred])
var_error$prot <- factor(var_error$prot,levels = var_error$prot)
p1 <- ggplot(var_error, aes(x=prot, y=Error,group = 1))+
  geom_point() + geom_line() + theme_bw()  + theme(axis.text.x=element_text(size=10),
          axis.text.y=element_text(size=15),
          axis.title=element_text(size=16),
          plot.title=element_text(size=18),
          legend.title=element_text(size=16),
          legend.text=element_text(size=15),
          legend.position = "none") + ylab("OOB error rate") + xlab("")

gridExtra::grid.arrange(grobs=list(p,p1), ncol=2, nrow=1)

```


```{r}
preds <- predict(vsel,dat.s[,1:(dim(dat.s)[2] - 1)],step = "pred")
preds2 <- predict(vsel,dat.s[,1:(dim(dat.s)[2] - 1)],step = "pred",type = "prob")
caret::confusionMatrix(preds,factor(dat.s[,dim(dat.s)[2]]))

Gene_ID <- gsub("-","\\.",colnames(dat.s[,1:(dim(dat.s)[2] - 1)])[vsel$varselect.pred])


library(pROC)
auc <-roc(dat.s[,dim(dat.s)[2]],preds2[,2])
print(auc)

roc(dat.s[,dim(dat.s)[2]], preds2[,2], percent=F, boot.n=1000, ci.alpha=0.95, stratified=FALSE, plot=TRUE, grid=TRUE, show.thres=TRUE, legacy.axes = TRUE, reuse.auc = TRUE,print.auc = TRUE, print.thres.col = "blue", ci=TRUE, ci.type="bars", print.thres.cex = 0.7, main = paste(" ") )



library('caret')
fitControl <- caret::trainControl(method = "repeatedcv", 
                        number = 5, 
                        repeats = 6)
dat.s[,dim(dat.s)[2]] <- factor(dat.s[,dim(dat.s)[2]])
as <- caret::train(as.formula(paste0("M36_dlco_80.f~",paste(Gene_ID,collapse = "+"))),
                                      data=dat.s ,method='rf', trControl = fitControl)

as
caret::confusionMatrix(as)

dat.s$exitus.num <- ifelse(dat.s$M36_dlco_80.f == ">80","control","Fallecido")
# 
# library(caret)
 library(MLeval)
# 
# Caret train function output object -- repeated cross validation
# run caret
# fitControl <- trainControl(
# method = "repeatedcv", number = 5, repeats = 6,
# summaryFunction=twoClassSummary,
# classProbs=T,
# savePredictions = T)
# fit2 <- train(as.formula(paste0("I(M36_dlco_80.f == '<80') ~",paste(Gene_ID,collapse = "+"))), data = dat.s,
# method = "rf",
# trControl = fitControl,metric = "ROC",
# verbose = FALSE)

# fit2
 
# # plot rocs
 # test4 <- evalm(list(fit1))
 # tesd4$optres
```

### Stepwise dicotomico 

**Incluye los miRNAs del randomForest**

```{r}

library(maxstat)
dat$ratio1 <- dat$RedCap


for( i in miRNAs){
  dat$mir1 <- dat[,i]
  mtHL <- maxstat.test(I(M36_dlco_80== "<80") ~ mir1,data= dat , smethod="Wilcoxon", pmethod="HL",minprop = 0.10)
  dat$ratio1 <- if_else(dat$mir1> mtHL$estimate, "High","Low")
  dat$ratio1 <- relevel(factor(dat$ratio1),ref = "Low")
  dat[,paste0(i,".cat")] <- dat$ratio1 
}




dat.s <- dat %>% dplyr::select(M36_dlco_80.f,IH_age_estimateyears,IH_sex, IH_smoking_mhyn, IH_hypertension_mhyn, AH_noninvaisve_prdur, AH_invasive_prdur, AH_ef_infyn, IU_filtrado, paste0(Gene_ID,".cat")) %>% filter(complete.cases(.))
set.seed(125)
scope <- list(upper =  formula(paste0("~  IH_age_estimateyears + IH_sex + IH_smoking_mhyn + IH_hypertension_mhyn + AH_noninvaisve_prdur + AH_invasive_prdur + AH_ef_infyn + IU_filtrado +",paste0(Gene_ID,".cat", collapse = "+"))) ,
              lower = ~  IH_age_estimateyears + IH_sex + IH_smoking_mhyn + IH_hypertension_mhyn + AH_noninvaisve_prdur + AH_invasive_prdur + AH_ef_infyn + IU_filtrado )

f1 <- glm(M36_dlco_80.f ~  IH_age_estimateyears + IH_sex + IH_smoking_mhyn + IH_hypertension_mhyn + AH_noninvaisve_prdur + AH_invasive_prdur + AH_ef_infyn + IU_filtrado ,data = dat.s,family = "binomial")
fit <- step(f1, scope = scope,scale = TRUE,trace = FALSE)

summary(fit)




test_pred <- predict(fit, type = "link")
test_pred2 <- predict(f1, type = "link")

auc1 <-auc(roc(fit$data$M36_dlco_80.f,test_pred))
auc2 <- auc(roc(f1$data$M36_dlco_80.f,test_pred2))
# compare concordance values of fit4 and fit5
roc.test(roc(fit$data$M36_dlco_80.f,test_pred),roc(f1$data$M36_dlco_80.f,test_pred2))

test_pred <- predict(fit, type = "response")
test_pred2 <- predict(f1, type = "response")

dat.s$M36_dlco_80.f <- ifelse(dat.s$M36_dlco_80.f == ">80",0,1)
PredictABEL::reclassification(data = dat.s, 
                              cOutcome = 1, 
                              predrisk1 = test_pred2, # original model
                              predrisk2 = test_pred, # updated model
                              cutoff = c(0,0.5,1))
```



### Stepwise continuo  

**Incluye los miRNAs de LASSO**


```{r}

if(nrow(to_plot_l[which(to_plot_l$coefficient != 0),]) !=0){
Gene_ID <- to_plot_l[which(to_plot_l$coefficient != 0),"feature"]$feature
dat.s <- dat %>% dplyr::select(M36_dlco_80.f,IH_age_estimateyears,IH_sex, IH_smoking_mhyn, IH_hypertension_mhyn, AH_noninvaisve_prdur, AH_invasive_prdur, AH_ef_infyn, IU_filtrado,Gene_ID) %>% filter(complete.cases(.))
set.seed(125)
scope <- list(upper =  formula(paste0("~  IH_age_estimateyears + IH_sex + IH_smoking_mhyn + IH_hypertension_mhyn + AH_noninvaisve_prdur + AH_invasive_prdur + AH_ef_infyn + IU_filtrado +",paste0(Gene_ID, collapse = "+"))) ,
              lower = ~  IH_age_estimateyears + IH_sex + IH_smoking_mhyn + IH_hypertension_mhyn + AH_noninvaisve_prdur + AH_invasive_prdur + AH_ef_infyn + IU_filtrado )

f1 <- glm(M36_dlco_80.f ~  IH_age_estimateyears + IH_sex + IH_smoking_mhyn + IH_hypertension_mhyn + AH_noninvaisve_prdur + AH_invasive_prdur + AH_ef_infyn + IU_filtrado ,data = dat.s,family = "binomial")
fit <- step(f1, scope = scope,scale = TRUE,trace = FALSE)

summary(fit)




test_pred <- predict(fit, type = "link")
test_pred2 <- predict(f1, type = "link")

auc1 <-auc(roc(fit$data$M36_dlco_80.f,test_pred))
auc2 <- auc(roc(f1$data$M36_dlco_80.f,test_pred2))
# compare concordance values of fit4 and fit5
roc.test(roc(fit$data$M36_dlco_80.f,test_pred),roc(f1$data$M36_dlco_80.f,test_pred2))

test_pred <- predict(fit, type = "response")
test_pred2 <- predict(f1, type = "response")

dat.s$M36_dlco_80.f <- ifelse(dat.s$M36_dlco_80.f == ">80",0,1)
PredictABEL::reclassification(data = dat.s, 
                              cOutcome = 1, 
                              predrisk1 = test_pred2, # original model
                              predrisk2 = test_pred, # updated model
                              cutoff = c(0,0.5,1))
}
```




## Correlacion de los miRNAs con outcomes en continuo 


```{r,fig.height=20,fig.width=20}
vec_names_bas <- dat %>%  dplyr::select(M36_followup_dlco, M36_followup_spirometry_fev, M36_followup_spirometry_fvc, M36_followup_spirometry_fev_fvc,miRNAs)

library(corrplot)
M = cor(vec_names_bas,use = "pairwise.complete.obs")
corrplot(M[5:20,1:4], method = 'number',col = "black")

```


